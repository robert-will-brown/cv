name: Produce and Publish PDF
on:
  push:
    paths:
      - 'rb-cv.tex'
jobs:
  publish_pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v2
      - name: Get Current Date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - name: Get Githash
        id: git_hash
        run: echo "::set-output name=git_hash::$(git rev-parse --short "$GITHUB_SHA")"
      - name: Get Git Branch
        id: git_branch
        run: echo "::set-output name=git_branch::${GITHUB_REF#refs/heads/}"
      - name: Set Version in Document
        uses: jacobtomlinson/gha-find-replace@v2
        with:
          find: "@@version@@"
          replace: "${{ steps.date.outputs.date }}-${{ steps.git_branch.outputs.git_branch }}-${{ steps.git_hash.outputs.git_hash }}"
          regex: false
      - name: Compile LaTeX Document
        uses: xu-cheng/latex-action@v2
        with:
          root_file: rb-cv.tex
      - name: Generate Thumbnail
        uses: jruipinto/ImageMagick-action@v1
        with:
          command: convert -density 700 -resize 10% -append -quality 98 -alpha remove rb-cv.pdf\[0\] rb-cv-thumbnail.jpg
      - name: Upload PDF to S3
        id: upload
        uses: hkusu/s3-upload-action@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: 'eu-west-1'
          aws-bucket: ${{ secrets.AWS_BUCKET }}
          file-path: './rb-cv.pdf'
          destination-dir: '/'
      - name: Upload Thumbnail to S3
        id: upload
        uses: hkusu/s3-upload-action@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: 'eu-west-1'
          aws-bucket: ${{ secrets.AWS_BUCKET }}
          file-path: './rb-cv-thumbnail.jpg'
          destination-dir: '/'
